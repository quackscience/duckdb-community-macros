<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>URL Redirector</title>
    <script>
      /**
       * Configuration
       */
      const CONFIG = {
        GITHUB_ISSUES_LINK: "https://api.github.com/repos/quackscience/duckdb-community-macros/issues/",
        GITHUB_FILES_LINK: "https://api.github.com/repos/quackscience/duckdb-community-macros/contents/links/",
        GITHUB_REPO: "https://github.com/quackscience/duckdb-community-macros",
        PATH_SEGMENTS_TO_SKIP: 0
      };

      function isUrl(url) {
        return /^https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,24}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)+$/.test(url);
      }

      async function tryIssueRedirect(issueNumber) {
        try {
          const response = await fetch(CONFIG.GITHUB_ISSUES_LINK + issueNumber);
          const data = await response.json();
          return data.title || null;
        } catch (e) {
          console.error("Issue redirect failed:", e);
          return null;
        }
      }

      async function tryFileRedirect(path) {
        try {
          const response = await fetch(CONFIG.GITHUB_FILES_LINK + path);
          const data = await response.json();
          return atob(data.content.trim()) || null;
        } catch (e) {
          console.error("File redirect failed:", e);
          return null;
        }
      }

      async function redirect() {
        const location = window.location;
        const pathParts = location.pathname.split("/").filter(part => part);
        
        // Default to homepage if no path
        if (pathParts.length === 0) {
          location.replace(CONFIG.GITHUB_REPO);
          return;
        }

        let url = null;
        const prefix = pathParts[0];
        const identifier = pathParts[1];

        // Only proceed if we have both prefix and identifier
        if (prefix && identifier) {
          if (prefix === 'r') {
            // File-based redirect for /r/ paths
            url = await tryFileRedirect(identifier);
          } 
          else if (prefix === 'i') {
            // Issue-based redirect for /i/ paths
            if (/^\d+$/.test(identifier)) {
              url = await tryIssueRedirect(identifier);
            }
          }
        }

        // If we found a valid URL, try to redirect
        if (url && isUrl(url)) {
          const targetUrl = document.createElement("a");
          targetUrl.setAttribute("href", url);
          
          // Prevent recursive redirects
          if (targetUrl.hostname !== location.hostname) {
            location.replace(url);
            return;
          }
        }

        // Fallback to repository page for invalid routes
        location.replace(CONFIG.GITHUB_REPO);
      }

      redirect();
    </script>
  </head>
  <body>
    <noscript>JavaScript is required for redirection.</noscript>
  </body>
</html>
